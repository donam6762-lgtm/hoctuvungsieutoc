<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web H·ªçc Ti·∫øng Nh·∫≠t C·ªßa T√¥i</title>
    <style>
        /* --- CSS: Giao di·ªán --- */
        :root {
            --primary-color: #ff4757;
            --secondary-color: #747d8c;
            --bg-color: #f1f2f6;
            --modal-overlay: rgba(0,0,0,0.5);
            --sidebar-width: 280px;
            --success-color: #2ed573;
            --warning-color: #ffa502;
            --danger-color: #ff4757;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: row;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            padding: 20px;
            background: var(--primary-color);
            color: white;
            text-align: center;
        }
        
        .sidebar-header h2 { margin: 0; font-size: 1.2rem; }

        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .list-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: 0.2s;
            position: relative;
        }

        .list-item:hover { background-color: #f1f2f6; }
        .list-item.active { background-color: #ffeaa7; border-left: 5px solid var(--primary-color); }
        
        .list-name { font-weight: bold; display: block; margin-bottom: 5px; }
        .list-date { font-size: 0.8rem; color: #888; }
        .list-delete {
            position: absolute;
            right: 10px;
            top: 15px;
            color: #ff4757;
            cursor: pointer;
            font-size: 1.2rem;
            display: none;
        }
        .list-item:hover .list-delete { display: block; }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            width: calc(100% - var(--sidebar-width));
        }

        h1 { color: var(--primary-color); margin-bottom: 10px; }

        /* Khu v·ª±c Flashcard */
        .flashcard-section {
            margin-top: 20px;
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .card-container {
            width: 300px;
            max-width: 90vw;
            height: 380px; /* TƒÉng chi·ªÅu cao ƒë·ªÉ ch·ª©a Tab */
            perspective: 1000px;
            margin-bottom: 20px;
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .card.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            background: white;
            border: 2px solid var(--primary-color);
            box-sizing: border-box;
            padding: 0; /* Reset padding ƒë·ªÉ custom tab */
            overflow: hidden;
        }

        .card-front { 
            font-size: 2.5rem; 
            color: #2f3542; 
            padding: 15px;
            /* background-color: #e3f2fd; Removed: Background applied to text span only */
        }
        
        .kanji-bg {
            background-color: #e3f2fd;
            padding: 15px 30px;
            border-radius: 15px;
            display: inline-block;
        }

        .card-slogan {
            position: absolute;
            bottom: 20px;
            font-size: 1rem;
            font-style: italic;
            color: #e67e22; /* Orange color */
            font-weight: 500;
        }
        
        .card-back {
            background-color: white; /* ƒê·ªïi n·ªÅn tr·∫Øng ƒë·ªÉ d·ªÖ nh√¨n */
            color: #2f3542;
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        /* TABS Interface */
        .tabs {
            display: flex;
            width: 100%;
            border-bottom: 1px solid #ddd;
            background: #f1f2f6;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #747d8c;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: white;
        }
        
        .tab-content {
            padding: 20px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
            display: none;
            text-align: left;
        }
        
        .tab-content.active { display: block; }
        
        /* N·ªôi dung Tab Th√¥ng tin */
        .word-reading { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); text-align: center; margin-bottom: 10px; }
        .word-mean { font-size: 1.2rem; margin-bottom: 15px; text-align: center; font-weight: 500; }
        .word-example { 
            font-size: 0.95rem; 
            margin-top: 15px; 
            font-style: italic !important; 
            background: #ffcdd2; /* ƒê·ªè r√µ h∆°n (Red 100) */
            color: #b71c1c; /* Ch·ªØ ƒë·ªè ƒë·∫≠m cho h·ª£p t√¥ng */
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
        }

        /* N·ªôi dung Tab Ghi ch√∫ */
        .note-input {
            width: 100%;
            height: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            box-sizing: border-box;
        }
        .note-input:focus { outline: none; border-color: var(--primary-color); }

        /* Japanese Style Status Buttons */
        .status-group-jp {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .jp-btn {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 2px solid #ddd;
            background: white;
            font-size: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 0 #ddd;
        }
        
        .jp-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ddd;
        }
        
        .jp-btn.btn-circle { color: var(--success-color); border-color: var(--success-color); }
        .jp-btn.btn-triangle { color: var(--warning-color); border-color: var(--warning-color); }
        .jp-btn.btn-cross { color: var(--danger-color); border-color: var(--danger-color); }
        
        .jp-btn:hover { background-color: #f9f9f9; }
        
        /* Hi·ªáu ·ª©ng khi ƒë∆∞·ª£c ch·ªçn */
        .jp-btn.selected {
            background-color: currentColor;
            color: white;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        .jp-btn.selected:active { transform: none; }

        .status-label {
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
            color: #57606f;
        }

        /* N√∫t ƒëi·ªÅu h∆∞·ªõng nh·ªè */
        .nav-group {
            display: flex;
            justify-content: space-between;
            width: 300px;
            margin-top: 20px;
        }
        
        .nav-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }

        /* Navigation Arrows (Floating) */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 2px solid #ddd;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: var(--secondary-color);
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: 0.2s;
            user-select: none;
        }

        .nav-arrow:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .nav-arrow:active { transform: translateY(-50%) scale(0.9); }

        /* V·ªã tr√≠ s√°t khung ƒë·ªè (c√°ch 55px t·ª´ m√©p container) */
        .nav-arrow.left { left: -55px; }
        .nav-arrow.right { right: -55px; }

        /* Responsive Arrows */
        @media (max-width: 500px) {
            /* Thu nh·ªè card m·ªôt ch√∫t ƒë·ªÉ ch·ª´a ch·ªó cho m≈©i t√™n */
            .card-container { max-width: 75vw; } 
            
            .nav-arrow { width: 35px; height: 35px; font-size: 1rem; }
            .nav-arrow.left { left: -40px; }
            .nav-arrow.right { right: -40px; }
        }

        .action-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 10px 20px;
            font-size: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        button.btn-secondary { background: var(--secondary-color); }
        button.btn-add { background: #2ed573; }
        button.btn-import { background: #3742fa; }
        button.btn-review { background: #ffa502; color: black; font-weight: bold; }

        button:hover { opacity: 0.9; transform: translateY(-2px); }
        button:active { transform: translateY(0); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 { color: var(--primary-color); margin-top: 0; }

        /* Review List Styles */
        .review-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f1f1;
        }
        .review-item:last-child { border-bottom: none; }
        .review-item:hover { background-color: #f9f9f9; }
        .ri-word { font-weight: bold; color: #2f3542; }
        .ri-mean { color: #747d8c; font-size: 0.9rem; margin-left: 10px; flex: 1; text-align: right; margin-right: 10px; }
        .ri-status { font-weight: bold; }
        .status-x { color: var(--danger-color); }
        .status-tri { color: var(--warning-color); }

        /* Test Modal Styles */
        .test-container {
            text-align: center;
        }
        .test-question {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: bold;
        }
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .test-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
            color: #2f3542;
        }
        .test-option:hover {
            background-color: #f1f2f6;
            border-color: #ccc;
        }
        .test-option.correct {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        .test-option.wrong {
            background-color: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }
        .test-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #57606f;
            margin-bottom: 10px;
        }

        .footer-slogan {
            margin-top: 50px;
            color: #bdc3c7;
            font-style: italic;
            font-size: 0.95rem;
            text-align: center;
            font-weight: 500;
        }

        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #57606f; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;
            font-family: inherit; box-sizing: border-box;
        }
        .input-group input:focus, .input-group textarea:focus { border-color: var(--primary-color); outline: none; }
        
        .help-text {
            font-size: 0.85rem; color: #666; margin-bottom: 5px; background: #f1f2f6;
            padding: 10px; border-radius: 5px; text-align: left;
        }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        
        /* B·ªô ƒë·∫øm */
        .counter { margin-top: 5px; font-weight: bold; color: #57606f; font-size: 0.9rem; }
        
        /* Responsive Mobile */
        @media (max-width: 600px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; border-right: none; border-bottom: 1px solid #ddd; }
            .list-container { display: none; } /* ·∫®n list tr√™n mobile cho g·ªçn, c√≥ th·ªÉ l√†m n√∫t toggle sau */
            .sidebar-header { padding: 10px; cursor: pointer; }
            .main-content { margin-left: 0; width: 100%; padding: 10px; box-sizing: border-box; }
            .sidebar.mobile-open .list-container { display: block; height: 200px; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header" onclick="toggleSidebar()">
            <h2>üìö Danh s√°ch b√†i h·ªçc</h2>
        </div>
        <div class="list-container" id="listContainer">
            <!-- List items will be injected here -->
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <h1 id="listTitle">JLPT Flashcards üáØüáµ</h1>

        <div class="flashcard-section">
            <div class="card-container">
                <!-- Navigation Arrows -->
                <div class="nav-arrow left" onclick="prevCard()">‚ùÆ</div>
                <div class="nav-arrow right" onclick="nextCard()">‚ùØ</div>

                <div class="card" id="card">
                    <!-- M·∫∑t tr∆∞·ªõc: Ch·ªâ c√≥ Kanji -->
                    <div class="card-face card-front" onclick="flipCard()">
                        <span id="frontText" class="kanji-bg">ÂÖàÁîü</span>
                        <div class="card-slogan">"Á∂ôÁ∂ö„ÅØÂäõ„Å™„Çä"</div>
                    </div>
                    
                    <!-- M·∫∑t sau: C√≥ Tabs -->
                    <div class="card-face card-back" id="backText" onclick="flipCard()">
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('info', event)">Th√¥ng tin</div>
                            <div class="tab" onclick="switchTab('note', event)">Ghi ch√∫</div>
                        </div>
                        
                        <!-- Tab Th√¥ng tin -->
                        <div class="tab-content active" id="tabInfo">
                            <div class="word-reading" id="displayReading">Sensei</div>
                            <div class="word-mean" id="displayMean">(Gi√°o vi√™n)</div>
                            <div class="word-example" id="displayExample">V√≠ d·ª•: ÂÖàÁîü„ÅØË¶™Âàá„Åß„Åô„ÄÇ</div>
                        </div>
                        
                        <!-- Tab Ghi ch√∫ -->
                        <div class="tab-content" id="tabNote">
                            <textarea class="note-input" id="noteInput" placeholder="Ghi ch√∫ c·ªßa b·∫°n cho t·ª´ n√†y..." onchange="saveNote()" onclick="event.stopPropagation()"></textarea>
                        </div>
                        <div class="card-slogan">"Á∂ôÁ∂ö„ÅØÂäõ„Å™„Çä"</div>
                    </div>
                </div>
            </div>

            <!-- Japanese Status Buttons -->
            <div class="status-label">Ch·ªçn m·ª©c ƒë·ªô hi·ªÉu ƒë·ªÉ qua t·ª´ ti·∫øp theo:</div>
            <div class="status-group-jp">
                <div class="jp-btn btn-circle" id="btnCircle" onclick="setStatusAndNext('O')" title="ƒê√£ thu·ªôc (O)">O</div>
                <div class="jp-btn btn-triangle" id="btnTriangle" onclick="setStatusAndNext('Œî')" title="T·∫°m ƒë∆∞·ª£c (Œî)">Œî</div>
                <div class="jp-btn btn-cross" id="btnCross" onclick="setStatusAndNext('X')" title="Ch∆∞a thu·ªôc (X)">X</div>
            </div>
            
            <div class="counter" id="wordCounter">T·ª´ 1 / 7</div>

            <div class="action-group">
                <button class="btn-import" onclick="openBulkModal()">+ Import nhi·ªÅu t·ª´</button>
                <button class="btn-review" onclick="filterReviewWords()">‚ö† √în t·∫≠p (Œî & X)</button>
                <button class="btn-secondary" onclick="startTestMode()" style="background: #a55eea; color: white;">‚úé L√†m b√†i ki·ªÉm tra</button>
                <button class="btn-secondary" onclick="resetFilter()" id="btnResetFilter" style="display:none">Hi·ªán t·∫•t c·∫£</button>
            </div>
        </div>
        

    </div>

    <!-- Modal Test Mode -->
    <div class="modal-overlay" id="testModal">
        <div class="modal-content">
            <h3>Ki·ªÉm tra Tr·∫Øc nghi·ªám</h3>
            <div class="test-container" id="testContainer">
                <div class="test-score" id="testScore">C√¢u 1/10 - ƒêi·ªÉm: 0</div>
                <div class="test-question" id="testQuestion">ÂÖàÁîü</div>
                <div class="test-grid" id="testOptions">
                    <div class="test-option">Gi√°o vi√™n</div>
                    <div class="test-option">H·ªçc sinh</div>
                    <div class="test-option">B√°c sƒ©</div>
                    <div class="test-option">K·ªπ s∆∞</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('testModal')">Tho√°t</button>
            </div>
        </div>
    </div>

    <!-- Modal Review List -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal-content">
            <h3>Danh s√°ch c·∫ßn √¥n t·∫≠p</h3>
            <div class="review-list" id="reviewListContainer">
                <!-- Items will be injected here -->
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('reviewModal')">ƒê√≥ng</button>
                <button class="btn-review" onclick="startReviewSession()">B·∫Øt ƒë·∫ßu √¥n ngay!</button>
            </div>
        </div>
    </div>

    <!-- Modal Import Nhi·ªÅu T·ª´ -->
    <div class="modal-overlay" id="bulkModal">
        <div class="modal-content">
            <h3>Import Danh S√°ch T·ª´ V·ª±ng</h3>
            <div class="input-group">
                <label>T√™n danh s√°ch (B√†i h·ªçc):</label>
                <input type="text" id="listNameInput" placeholder="V√≠ d·ª•: B√†i 1 - Kinh t·∫ø">
            </div>
            <div class="help-text">
                <strong>ƒê·ªãnh d·∫°ng h·ªó tr·ª£:</strong><br>
                1. <code>Kanji | Kana | Nghƒ©a</code><br>
                2. <code>Kanji (Kana),Nghƒ©a</code><br>
                3. <code>Kanji Kana = Nghƒ©a</code><br>
                <em>(H·ªó tr·ª£ d√°n nhi·ªÅu v√≠ d·ª•: D√πng s·ªë 1, 2... ·ªü ƒë·∫ßu d√≤ng)</em>
            </div>
            <div class="input-group">
                <label>D√°n danh s√°ch t·ª´ v·ª±ng t·∫°i ƒë√¢y:</label>
                <textarea id="bulkInput" rows="8" placeholder="D√°n danh s√°ch t·ª´ c·ªßa b·∫°n v√†o ƒë√¢y..."></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal('bulkModal')">H·ªßy</button>
                <button onclick="processBulkImport()">L∆∞u & Import</button>
            </div>
        </div>
    </div>

    <script>
        /* --- JAVASCRIPT: Logic Qu·∫£n l√Ω --- */

        // State Global
        let lists = []; 
        let currentListId = null; 
        let currentWords = []; 
        let currentIndex = 0;
        let isReviewMode = false;

        // Default Data
        const defaultData = [
            { kanji: "ÂÖàÁîü", reading: "„Åõ„Çì„Åõ„ÅÑ", mean: "Gi√°o vi√™n", example: "ÂÖàÁîü„ÅØË¶™Âàá„Åß„Åô„ÄÇ", status: "", note: "" },
            { kanji: "Â≠¶Áîü", reading: "„Åå„Åè„Åõ„ÅÑ", mean: "H·ªçc sinh", example: "ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô„ÄÇ", status: "", note: "" },
            { kanji: "Êó•Êú¨Ë™û", reading: "„Å´„Åª„Çì„Åî", mean: "Ti·∫øng Nh·∫≠t", example: "", status: "", note: "" }
        ];

        // DOM Elements
        const card = document.getElementById('card');
        const displayReading = document.getElementById('displayReading');
        const displayMean = document.getElementById('displayMean');
        const displayExample = document.getElementById('displayExample');
        const frontText = document.getElementById('frontText');
        const wordCounter = document.getElementById('wordCounter');
        const listTitle = document.getElementById('listTitle');
        const listContainer = document.getElementById('listContainer');
        const noteInput = document.getElementById('noteInput');
        
        // Status Buttons
        const btnCircle = document.getElementById('btnCircle');
        const btnTriangle = document.getElementById('btnTriangle');
        const btnCross = document.getElementById('btnCross');

        // --- KH·ªûI T·∫†O ---
        window.onload = function() {
            loadListsFromStorage();
            if (lists.length === 0) createList("B√†i m·∫´u (Demo)", defaultData);
            selectList(lists[0].id);

        };

        // --- STORAGE & LISTS ---
        function saveListsToStorage() {
            localStorage.setItem('myFlashcards', JSON.stringify(lists));
            renderSidebar();
        }

        function loadListsFromStorage() {
            const data = localStorage.getItem('myFlashcards');
            if (data) lists = JSON.parse(data);
        }

        function createList(name, words) {
            const newList = { id: Date.now().toString(), name: name, date: new Date().toLocaleDateString(), words: words };
            lists.push(newList);
            saveListsToStorage();
            return newList.id;
        }
        
        function deleteList(id, event) {
            event.stopPropagation();
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc n√†y kh√¥ng?")) {
                lists = lists.filter(l => l.id !== id);
                saveListsToStorage();
                if (lists.length > 0) selectList(lists[0].id);
                else { currentWords = []; updateCardDisplay({kanji: "Tr·ªëng", reading: "", mean: "H√£y th√™m b√†i h·ªçc m·ªõi"}); }
            }
        }

        function selectList(id) {
            currentListId = id;
            const list = lists.find(l => l.id === id);
            if (list) {
                currentWords = list.words;
                currentIndex = 0;
                isReviewMode = false;
                document.getElementById('btnResetFilter').style.display = 'none';
                listTitle.innerText = list.name;
                if (currentWords.length > 0) updateCardDisplay(currentWords[0]);
                updateCounter();
                renderSidebar();
            }
        }

        function renderSidebar() {
            listContainer.innerHTML = '';
            lists.forEach(list => {
                const div = document.createElement('div');
                div.className = `list-item ${list.id === currentListId ? 'active' : ''}`;
                div.onclick = () => selectList(list.id);
                div.innerHTML = `
                    <span class="list-name">${list.name}</span>
                    <span class="list-date">${list.words.length} t·ª´ ‚Ä¢ ${list.date}</span>
                    <span class="list-delete" onclick="deleteList('${list.id}', event)">√ó</span>
                `;
                listContainer.appendChild(div);
            });
        }
        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('mobile-open'); }

        // --- FLASHCARD LOGIC ---

        function updateCardDisplay(item) {
            if (!item) return;

            // T·ª± ƒë·ªông t√°ch v√≠ d·ª• n·∫øu n√≥ b·ªã d√≠nh v√†o ph·∫ßn Nghƒ©a (Fix l·ªói hi·ªÉn th·ªã c≈©)
            let mean = item.mean || '';
            let example = item.example || '';
            
            const splitMarkers = ["‰æãÔºö", "‰æã:", "V√≠ d·ª•:", "Ex:", "Example:"];
            for (const marker of splitMarkers) {
                if (mean.includes(marker)) {
                    const parts = mean.split(marker);
                    mean = parts[0].trim();
                    // Lo·∫°i b·ªè d·∫•u ngo·∫∑c th·ª´a ·ªü cu·ªëi n·∫øu c√≥ (do format c≈©)
                    if (mean.endsWith('(')) mean = mean.slice(0, -1).trim();
                    
                    const extractedEx = marker + " " + parts.slice(1).join(marker).trim();
                    // Lo·∫°i b·ªè d·∫•u ƒë√≥ng ngo·∫∑c th·ª´a ·ªü cu·ªëi v√≠ d·ª• n·∫øu c√≥
                    const cleanEx = extractedEx.endsWith(')') ? extractedEx.slice(0, -1) : extractedEx;
                    
                    if (example) example = cleanEx + "<br>" + example;
                    else example = cleanEx;
                    break; 
                }
            }

            // Update Content
            frontText.innerText = item.kanji;
            displayReading.innerText = item.reading || '';
            displayMean.innerText = mean ? `(${mean})` : '';
            displayExample.innerHTML = example || '';
            
            // Update Note
            noteInput.value = item.note || "";
            
            // Reset Tabs (Always show Info first)
            switchTab('info', null);
            
            // Highlight Status Button
            updateStatusUI(item.status);
        }
        
        function updateStatusUI(status) {
            btnCircle.classList.remove('selected');
            btnTriangle.classList.remove('selected');
            btnCross.classList.remove('selected');
            
            if (status === 'O') btnCircle.classList.add('selected');
            if (status === 'Œî') btnTriangle.classList.add('selected');
            if (status === 'X') btnCross.classList.add('selected');
        }

        function flipCard() {
            card.classList.toggle('is-flipped');
        }
        
        function switchTab(tabName, event) {
            if (event) event.stopPropagation(); // Prevent flipping
            
            // UI Update
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tabName === 'info') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('tabInfo').classList.add('active');
            } else {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('tabNote').classList.add('active');
            }
        }

        function nextCard() {
            if (currentWords.length === 0) return;

            if (currentIndex < currentWords.length - 1) {
                card.classList.remove('is-flipped');
                setTimeout(() => {
                    currentIndex++;
                    updateCardDisplay(currentWords[currentIndex]);
                    updateCounter();
                }, 300);
            } else {
                if (confirm("B·∫°n ƒë√£ h·ªçc h·∫øt danh s√°ch! B·∫°n c√≥ mu·ªën l√†m b√†i ki·ªÉm tra tr·∫Øc nghi·ªám kh√¥ng?")) {
                    startTestMode();
                } else {
                    alert("Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh danh s√°ch!");
                    card.classList.remove('is-flipped');
                    setTimeout(() => {
                        currentIndex = 0;
                        updateCardDisplay(currentWords[currentIndex]);
                        updateCounter();
                    }, 300);
                }
            }
        }

        function prevCard() {
            if (currentWords.length === 0) return;
            card.classList.remove('is-flipped');
            setTimeout(() => {
                currentIndex = (currentIndex - 1 + currentWords.length) % currentWords.length;
                updateCardDisplay(currentWords[currentIndex]);
                updateCounter();
            }, 300);
        }
        
        function updateCounter() {
            if (currentWords.length === 0) wordCounter.innerText = "0 / 0";
            else wordCounter.innerText = `T·ª´ ${currentIndex + 1} / ${currentWords.length}`;
        }

        // --- STATUS & AUTO NEXT ---

        function setStatusAndNext(status) {
            const word = currentWords[currentIndex];
            if (!word) return;

            // Save status
            word.status = status;
            saveListsToStorage();
            updateStatusUI(status);
            
            // Auto Next Card (sau 200ms ƒë·ªÉ ng∆∞·ªùi d√πng th·∫•y hi·ªáu ·ª©ng click)
            setTimeout(() => {
                nextCard();
            }, 200);
        }

        function saveNote() {
            const word = currentWords[currentIndex];
            if (word) {
                word.note = noteInput.value;
                saveListsToStorage();
            }
        }

        let reviewCandidates = [];

        function filterReviewWords() {
            const originalList = lists.find(l => l.id === currentListId);
            if (!originalList) return;

            // L·ªçc t·ª´ Œî v√† X
            reviewCandidates = originalList.words.filter(w => w.status === 'Œî' || w.status === 'X');
            
            if (reviewCandidates.length === 0) {
                alert("B·∫°n ƒë√£ thu·ªôc h·∫øt c√°c t·ª´ (O) r·ªìi! Gi·ªèi qu√°!");
                return;
            }

            // Hi·ªÉn th·ªã danh s√°ch l√™n Modal
            const container = document.getElementById('reviewListContainer');
            container.innerHTML = '';
            
            reviewCandidates.forEach(word => {
                const div = document.createElement('div');
                div.className = 'review-item';
                div.innerHTML = `
                    <span class="ri-word">${word.kanji}</span>
                    <span class="ri-mean">${word.mean}</span>
                    <span class="ri-status ${word.status === 'X' ? 'status-x' : 'status-tri'}">${word.status}</span>
                `;
                container.appendChild(div);
            });

            document.getElementById('reviewModal').classList.add('active');
        }

        function startReviewSession() {
            if (reviewCandidates.length === 0) return;

            currentWords = reviewCandidates;
            currentIndex = 0;
            isReviewMode = true;
            
            closeModal('reviewModal');
            document.getElementById('btnResetFilter').style.display = 'inline-block';
            
            updateCardDisplay(currentWords[0]);
            updateCounter();
        }

        function resetFilter() {
            const originalList = lists.find(l => l.id === currentListId);
            if (originalList) {
                currentWords = originalList.words;
                currentIndex = 0;
                isReviewMode = false;
                document.getElementById('btnResetFilter').style.display = 'none';
                updateCardDisplay(currentWords[0]);
                updateCounter();
            }
        }

        // --- MODAL & IMPORT ---
        
        function openBulkModal() { document.getElementById('bulkModal').classList.add('active'); document.getElementById('listNameInput').focus(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        function parseLine(line) {
            if (!line || line.trim() === "") return null;
            const pipeParts = line.split('|');
            let result = {};

            if (pipeParts.length >= 3) {
                result = {
                    kanji: pipeParts[0].trim(),
                    reading: pipeParts[1].trim(),
                    mean: pipeParts[2].trim(),
                    example: pipeParts.slice(3).join('|').trim().replace(/\n/g, "<br>")
                };
            } else {
                let mainPart = line;
                let example = "";
                if (pipeParts.length === 2 && (pipeParts[0].includes('=') || pipeParts[0].includes(','))) {
                     mainPart = pipeParts[0].trim(); example = pipeParts[1].trim();
                }
                
                let kanji = "", reading = "", mean = "";
                if (mainPart.includes(',')) {
                    const idx = mainPart.indexOf(',');
                    const left = mainPart.substring(0, idx).trim(); 
                    mean = mainPart.substring(idx + 1).trim();     
                    if (left.includes('(')) {
                        const op = left.indexOf('('); const cp = left.lastIndexOf(')');
                        kanji = left.substring(0, op).trim(); reading = left.substring(op + 1, cp).trim();
                    } else {
                        const sp = left.lastIndexOf(' ');
                        kanji = sp !== -1 ? left.substring(0, sp).trim() : left; reading = sp !== -1 ? left.substring(sp + 1).trim() : "";
                    }
                } else if (mainPart.includes('=')) {
                    const parts = mainPart.split('=');
                    const left = parts[0].trim(); mean = parts[1].trim();
                    const sp = left.lastIndexOf(' ');
                    kanji = sp !== -1 ? left.substring(0, sp).trim() : left; reading = sp !== -1 ? left.substring(sp + 1).trim() : "";
                } else { return null; }
                result = { kanji, reading, mean, example: example.replace(/\n/g, "<br>") };
            }
            result.status = ""; result.note = "";
            return result;
        }

        function processBulkImport() {
            const listName = document.getElementById('listNameInput').value.trim() || `B√†i h·ªçc ${new Date().toLocaleDateString()}`;
            const text = document.getElementById('bulkInput').value;
            if (!text.trim()) { alert("Vui l√≤ng nh·∫≠p n·ªôi dung!"); return; }
            
            const lines = text.split('\n');
            const newWords = [];
            let lastIdx = -1;

            lines.forEach(line => {
                const tLine = line.trim();
                if (!tLine) return;

                // 1. N·∫øu d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng "V√≠ d·ª•:", "Ex:", "‰æãÔºö" -> Th√™m v√†o v√≠ d·ª•
                const exampleRegex = /^(v√≠ d·ª•:|ex:|example:|‰æã[:Ôºö])/i;
                if (lastIdx !== -1 && exampleRegex.test(tLine)) {
                    const ex = tLine.replace(exampleRegex, '').trim();
                    if (newWords[lastIdx].example) newWords[lastIdx].example += "<br>" + ex;
                    else newWords[lastIdx].example = ex;
                    return;
                }

                // 2. ∆Øu ti√™n: N·∫øu d√≤ng ch·ª©a k√Ω t·ª± ph√¢n c√°ch m·∫°nh (| ho·∫∑c =) -> X·ª≠ l√Ω l√† T·ª™ M·ªöI
                if (tLine.includes('|') || tLine.includes('=')) {
                     const word = parseLine(line);
                     if (word) { newWords.push(word); lastIdx = newWords.length - 1; return; }
                }

                // 3. ∆Øu ti√™n: N·∫øu d√≤ng b·∫Øt ƒë·∫ßu b·∫±ng s·ªë (1., 2, 1) -> X·ª≠ l√Ω l√† V√ç D·ª§ (n·∫øu ƒë√£ c√≥ t·ª´ tr∆∞·ªõc ƒë√≥)
                // (ƒê·ªÉ tr√°nh b·ªã nh·∫ßm l√† t·ª´ m·ªõi n·∫øu d√≤ng v√≠ d·ª• c√≥ ch·ª©a d·∫•u ph·∫©y)
                if (lastIdx !== -1 && /^\d+([\.\)\s]|$)/.test(tLine)) {
                     if (newWords[lastIdx].example) newWords[lastIdx].example += "<br>" + tLine;
                     else newWords[lastIdx].example = tLine;
                     return;
                }

                // 4. Th·ª≠ parse d√≤ng th√†nh t·ª´ m·ªõi (d√†nh cho tr∆∞·ªùng h·ª£p d√πng d·∫•u ph·∫©y ho·∫∑c format kh√°c)
                const word = parseLine(line);
                if (word) { 
                    newWords.push(word); 
                    lastIdx = newWords.length - 1; 
                } else if (lastIdx !== -1) {
                    // 5. Fallback: Coi l√† d√≤ng ti·∫øp theo c·ªßa v√≠ d·ª•/ghi ch√∫
                    if (newWords[lastIdx].example) newWords[lastIdx].example += "<br>" + tLine;
                    else newWords[lastIdx].example = tLine;
                }
            });

            if (newWords.length > 0) {
                const newId = createList(listName, newWords);
                selectList(newId);
                closeModal('bulkModal');
                alert(`ƒê√£ t·∫°o b√†i h·ªçc "${listName}" v·ªõi ${newWords.length} t·ª´!`);
            } else { alert("Kh√¥ng t√¨m th·∫•y t·ª´ v·ª±ng h·ª£p l·ªá n√†o!"); }
        }
        
        /* --- TEST MODE LOGIC --- */
        let testQuestions = [];
        let currentTestIndex = 0;
        let testScore = 0;

        function startTestMode() {
            const originalList = lists.find(l => l.id === currentListId);
            if (!originalList || originalList.words.length < 4) {
                alert("C·∫ßn √≠t nh·∫•t 4 t·ª´ v·ª±ng ƒë·ªÉ t·∫°o b√†i ki·ªÉm tra!");
                return;
            }

            // Create questions
            testQuestions = originalList.words.map(target => {
                // Find 3 distractors
                const others = originalList.words.filter(w => w.kanji !== target.kanji);
                // Shuffle others to get random distractors
                const shuffledOthers = others.sort(() => 0.5 - Math.random());
                const distractors = shuffledOthers.slice(0, 3);
                
                // Combine and shuffle options
                const options = [target, ...distractors].sort(() => 0.5 - Math.random());
                
                return {
                    question: target,
                    options: options
                };
            });

            // Shuffle questions order
            testQuestions.sort(() => 0.5 - Math.random());
            
            // Limit to 10 or length
            testQuestions = testQuestions.slice(0, 20); // Max 20 questions

            currentTestIndex = 0;
            testScore = 0;
            showTestQuestion();
            document.getElementById('testModal').classList.add('active');
        }

        function showTestQuestion() {
            if (currentTestIndex >= testQuestions.length) {
                // End of test
                document.getElementById('testContainer').innerHTML = `
                    <div class="test-question">K·∫øt th√∫c!</div>
                    <div class="test-score">B·∫°n ƒë·∫°t: ${testScore}/${testQuestions.length} c√¢u ƒë√∫ng</div>
                    <div style="font-size: 5rem; margin: 20px;">
                        ${testScore === testQuestions.length ? 'üíØ' : testScore > testQuestions.length/2 ? 'üéâ' : 'üòÖ'}
                    </div>
                `;
                return;
            }

            const q = testQuestions[currentTestIndex];
            document.getElementById('testScore').innerText = `C√¢u ${currentTestIndex + 1}/${testQuestions.length} - ƒêi·ªÉm: ${testScore}`;
            document.getElementById('testQuestion').innerHTML = `<span class="kanji-bg">${q.question.kanji}</span>`;
            
            const optionsContainer = document.getElementById('testOptions');
            optionsContainer.innerHTML = '';

            q.options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'test-option';
                div.innerText = opt.mean;
                div.onclick = () => checkTestAnswer(div, opt, q.question);
                optionsContainer.appendChild(div);
            });
        }

        function checkTestAnswer(element, selected, correct) {
            // Disable all clicks
            const options = document.querySelectorAll('.test-option');
            options.forEach(opt => opt.onclick = null);

            if (selected.kanji === correct.kanji) {
                element.classList.add('correct');
                testScore++;
            } else {
                element.classList.add('wrong');
                // Highlight correct one
                options.forEach(opt => {
                    if (opt.innerText === correct.mean) {
                        opt.classList.add('correct');
                    }
                });
            }

            setTimeout(() => {
                currentTestIndex++;
                showTestQuestion();
            }, 1500);
        }


    </script>
</body>
</html>